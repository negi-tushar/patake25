<div class="container-fluid p-3 p-md-4">
  <!-- Header with actions -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
    <h2 class="mb-0">Manage Products</h2>
    <div class="d-flex flex-wrap gap-2">
      <button class="btn btn-primary" (click)="openProductModal()">+ Add Product</button>
      <label class="btn btn-outline-secondary mb-0">
        Import CSV
        <input type="file" accept=".csv" (change)="onCsvSelected($event)" hidden />
      </label>
      <button *ngIf="isAdmin()" class="btn btn-outline-danger" [disabled]="selectedProductIds.size === 0"
        (click)="deleteSelected()">
        Delete Selected ({{ selectedProductIds.size }})
      </button>
      <button class="btn btn-outline-secondary" (click)="refreshFromServer()">Refresh</button>
    </div>
  </div>

  <!-- Table wrapper -->
  <div class="table-responsive d-none d-md-block">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>
            <input type="checkbox" class="form-check-input" [checked]="isAllSelected((products$ | async)?.length || 0)"
              (change)="toggleSelectAll($event)" />
          </th>
          <th>Name</th>
          <th>Category</th>
          <th>Quantity</th>
          <th>Unit</th>
          <th class="text-end">Rate (₹)</th>
          <th class="text-end">Amount (₹)</th>
          <!-- <th class="text-end">Cost (₹)</th> -->
          <th class="text-end">Sell (₹)</th>
          <th class="text-end">Margin (%)</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngIf="products$ | async as products">
          <tr *ngFor="let product of products">
            <td>
              <input type="checkbox" class="form-check-input" [checked]="selectedProductIds.has(product.id!)"
                (change)="onProductSelect(product.id!, $event)" />
            </td>
            <td>{{ product.name }}</td>
            <td>{{ product.category }}</td>
            <td>{{ product.quantity }}</td>
            <td>{{ product.unit }}</td>
            <td class="text-end">{{ product.rate | number:'1.2-2' }}</td>
            <td class="text-end">{{ product.amount | number:'1.2-2' }}</td>
            <!-- <td class="text-end">{{ product.costPrice | number:'1.2-2' }}</td> -->
            <td class="text-end">{{ product.sellPrice | number:'1.2-2' }}</td>
            <td class="text-end">
              {{
              (
              ((product.sellPrice || 0) - (product.costPrice ?? product.rate || 0))
              / (product.costPrice ?? product.rate || 1)
              * 100
              ) | number:'1.0-2'
              }}
            </td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-primary me-2" (click)="openProductModal(product)">Edit</button>
              <button *ngIf="isAdmin()" class="btn btn-sm btn-outline-danger"
                (click)="deleteSingleProduct(product)">Delete</button>
            </td>
          </tr>
          <tr *ngIf="products.length === 0">
            <td colspan="11" class="text-center text-muted">No products found.</td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>

  <!-- Mobile Card View -->
  <div class="d-block d-md-none">
    <ng-container *ngIf="products$ | async as products">
      <div *ngFor="let product of products" class="card mb-3 shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <h5 class="card-title mb-1">{{ product.name }}</h5>
            <input type="checkbox" class="form-check-input" [checked]="selectedProductIds.has(product.id!)"
              (change)="onProductSelect(product.id!, $event)" />
          </div>
          <p class="text-muted small mb-2">{{ product.category }}</p>
          <div class="row g-2 small">
            <div class="col-6"><strong>Qty:</strong> {{ product.quantity }} {{ product.unit }}</div>
            <div class="col-6"><strong>Rate:</strong> ₹{{ product.rate | number:'1.2-2' }}</div>
            <div class="col-6"><strong>Amount:</strong> ₹{{ product.amount | number:'1.2-2' }}</div>
            <!-- <div class="col-6"><strong>Cost:</strong> ₹{{ product.costPrice | number:'1.2-2' }}</div> -->
            <div class="col-6"><strong>Sell:</strong> ₹{{ product.sellPrice | number:'1.2-2' }}</div>
            <div class="col-6"><strong>Margin:</strong>
              {{
              (
              ((product.sellPrice || 0) - (product.costPrice ?? product.rate || 0))
              / (product.costPrice ?? product.rate || 1)
              * 100
              ) | number:'1.0-2'
              }}%
            </div>
          </div>
          <div class="mt-3 d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary flex-grow-1" (click)="openProductModal(product)">Edit</button>
            <button *ngIf="isAdmin()" class="btn btn-sm btn-outline-danger flex-grow-1"
              (click)="deleteSingleProduct(product)">Delete</button>
          </div>
        </div>
      </div>

      <div *ngIf="products.length === 0" class="text-center text-muted py-3">
        No products found.
      </div>
    </ng-container>
  </div>
</div>


<!-- Reusable Add/Edit Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form [formGroup]="productForm" (ngSubmit)="saveProduct()">
        <div class="modal-header">
          <h5 class="modal-title">{{ isEditMode ? 'Edit Product' : 'Add New Product' }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Name <span class="text-danger">*</span></label>
              <input class="form-control" formControlName="name" placeholder="e.g. FIP big" />
            </div>
            <!-- START: Add Category Dropdown -->
            <div class="col-12">
              <label class="form-label">Category <span class="text-danger">*</span></label>
              <select class="form-select" formControlName="category">
                <option *ngFor="let category of crackerCategories" [value]="category">
                  {{ category }}
                </option>
              </select>
            </div>
            <!-- END: Add Category Dropdown -->
            <div class="col-6">
              <label class="form-label">Quantity <span class="text-danger">*</span></label>
              <input type="number" class="form-control" formControlName="quantity" min="0" />
            </div>
            <div class="col-6">
              <label class="form-label">Unit <span class="text-danger">*</span></label>
              <select class="form-select" formControlName="unit">
                <option value="box">box</option>
                <option value="unit">unit</option>
                <option value="pcs">pcs</option>
                <option value="bun">bun</option>
                <option value="case">case</option>
              </select>
            </div>
            <div class="col-6">
              <label class="form-label">Rate (₹) <span class="text-danger">*</span></label>
              <input type="number" class="form-control" formControlName="rate" min="0" />
            </div>
            <div class="col-6">
              <label class="form-label">Amount (₹)</label>
              <input type="number" class="form-control bg-light" formControlName="amount" readonly />
              <small class="text-muted">Auto-calculated</small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" [disabled]="productForm.invalid" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toast for feedback -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" *ngIf="showToastFlag()">
  <div class="toast show"
    [ngClass]="{'text-bg-success': toastType() === 'success', 'text-bg-danger': toastType() === 'error'}">
    <div class="d-flex">
      <div class="toast-body">{{ toastMessage() }}</div>
    </div>
  </div>
</div>
<!-- Margin Bulk Update Panel -->
<div *ngIf="isAdmin()" class="card mb-3 border-0 shadow-sm">
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-6 col-sm-3">
        <label class="form-label">Margin (%)</label>
        <input type="number" class="form-control" min="0" step="0.01" [(ngModel)]="bulkMarginPercent" />
      </div>
      <div class="col-6 col-sm-3">
        <label class="form-label">Scope</label>
        <select class="form-select" [(ngModel)]="bulkScope">
          <option value="selected">Selected products</option>
          <option value="all">All products</option>
        </select>
      </div>
      <div class="col-12 col-sm-3">
        <button class="btn btn-dark w-100" (click)="applyMargin()" [disabled]="!canApplyMargin()">
          Apply Margin
        </button>
      </div>
      <div class="col-12 col-sm-3">
        <small class="text-muted">
          New sell price = cost × (1 + margin/100)
        </small>
      </div>
    </div>
  </div>
</div>